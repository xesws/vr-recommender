<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VR Recommender - Data Management</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <style>
        body { background-color: #f4f6f9; }
        .card { border: none; shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .console-output {
            background-color: #1e1e1e;
            color: #00ff00;
            font-family: 'Courier New', Courier, monospace;
            padding: 15px;
            border-radius: 5px;
            height: 300px;
            overflow-y: auto;
            font-size: 0.9rem;
        }
        .status-dot {
            height: 10px; width: 10px; border-radius: 50%; display: inline-block;
        }
        .status-ok { background-color: #2ecc71; }
        .status-warn { background-color: #f1c40f; }
        .status-err { background-color: #e74c3c; }
        /* Overlay styles */
        #auth-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255,255,255,0.95); z-index: 9999;
            display: flex; align-items: center; justify-content: center;
        }
    </style>
</head>
<body>

<!-- Auth Overlay -->
<div id="auth-overlay">
    <div class="card shadow-lg p-4" style="width: 350px;">
        <h4 class="text-center mb-3"><i class="bi bi-shield-lock-fill text-primary"></i> Admin Login</h4>
        <div class="mb-3">
            <label class="form-label">Password</label>
            <input type="password" id="auth-pass" class="form-control" onkeyup="if(event.key==='Enter') doLogin()">
        </div>
        <button class="btn btn-primary w-100" onclick="doLogin()">Unlock</button>
        <p id="auth-error" class="text-danger mt-2 text-center small"></p>
    </div>
</div>

<nav class="navbar navbar-expand-lg navbar-dark bg-dark">
    <div class="container-fluid">
        <a class="navbar-brand" href="/admin">
            <i class="bi bi-shield-lock me-2"></i>Heinz VR Admin
        </a>
        <div class="collapse navbar-collapse">
            <ul class="navbar-nav me-auto mb-2 mb-lg-0">
                <li class="nav-item">
                    <a class="nav-link" href="/admin">Logs & Stats</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link active" href="/admin/data">Data Management</a>
                </li>
            </ul>
            <button class="btn btn-sm btn-danger ms-auto" onclick="doLogout()">
                <i class="bi bi-box-arrow-right"></i> Logout
            </button>
        </div>
    </div>
</nav>

<div class="container mt-4">
    <h4 class="mb-3">Data Management</h4>

    <!-- Status Cards -->
    <div class="row mb-4">
        <!-- Courses Status -->
        <div class="col-md-6">
            <div class="card mb-3">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h5 class="card-title"><i class="bi bi-book me-2"></i>Courses Data</h5>
                        <span id="course-status-dot" class="status-dot status-warn"></span>
                    </div>
                    <div class="row">
                        <div class="col-6">
                            <small class="text-muted">Total Courses</small>
                            <h3 id="course-count">-</h3>
                        </div>
                        <div class="col-6">
                            <small class="text-muted">Last Updated</small>
                            <p id="course-updated" class="mb-0 fw-bold">-</p>
                        </div>
                    </div>
                    <hr>
                    <h6>Update Actions</h6>
                    
                    <!-- Filters -->
                    <div class="row g-2 mb-2">
                        <div class="col-md-6">
                            <select class="form-select form-select-sm" id="course-dept">
                                <option value="">All Departments</option>
                                <option value="School of Computer Science">School of Computer Science</option>
                                <option value="Heinz College">Heinz College</option>
                                <option value="Tepper School of Business">Tepper School</option>
                                <option value="College of Engineering">Engineering</option>
                                <option value="Dietrich College">Dietrich College</option>
                                <option value="Mellon College of Science">Mellon Science</option>
                                <option value="College of Fine Arts">Fine Arts</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <select class="form-select form-select-sm" id="course-semester">
                                <option value="f25" selected>Fall 2025 (f25)</option>
                                <option value="s25">Spring 2025 (s25)</option>
                                <option value="s26">Spring 2026 (s26)</option>
                                <option value="f24">Fall 2024 (f24)</option>
                            </select>
                        </div>
                    </div>

                    <div class="input-group mb-2">
                        <select class="form-select" id="course-limit">
                            <option value="5">Test Run (Limit 5)</option>
                            <option value="50">Standard Update (Limit 50)</option>
                            <option value="999999">Full Update (All)</option>
                        </select>
                        <button class="btn btn-primary" onclick="updateCourses()" id="btn-update-courses">
                            <i class="bi bi-cloud-download me-1"></i>Update
                        </button>
                    </div>
                    <small class="text-danger"><i class="bi bi-exclamation-triangle me-1"></i>Full update consumes API credits.</small>
                </div>
            </div>
        </div>

        <!-- VR Apps Status -->
        <div class="col-md-6">
            <div class="card mb-3">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h5 class="card-title"><i class="bi bi-headset-vr me-2"></i>VR Apps Data</h5>
                        <span id="app-status-dot" class="status-dot status-warn"></span>
                    </div>
                    <div class="row">
                        <div class="col-6">
                            <small class="text-muted">Total Apps</small>
                            <h3 id="app-count">-</h3>
                        </div>
                        <div class="col-6">
                            <small class="text-muted">Last Updated</small>
                            <p id="app-updated" class="mb-0 fw-bold">-</p>
                        </div>
                    </div>
                    <hr>
                    <h6>Update Actions</h6>
                    <div class="d-flex gap-2">
                        <button class="btn btn-outline-primary w-100" onclick="updateApps()">
                            <i class="bi bi-arrow-repeat me-1"></i>Refresh All Apps
                        </button>
                    </div>
                    <div class="mt-2">
                        <small class="text-muted">Updates from curated list + web search.</small>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Processing Pipeline -->
    <h5 class="mb-3">Processing Pipeline</h5>
    <div class="row mb-4">
        <!-- Skill Extraction -->
        <div class="col-md-6">
            <div class="card mb-3 border-info">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h5 class="card-title"><i class="bi bi-lightbulb me-2"></i>Skill Extraction</h5>
                        <span id="skill-status-dot" class="status-dot status-warn"></span>
                    </div>
                    <div class="row">
                        <div class="col-6">
                            <small class="text-muted">Total Skills</small>
                            <h3 id="skill-count">-</h3>
                        </div>
                        <div class="col-6">
                            <small class="text-muted">Last Updated</small>
                            <p id="skill-updated" class="mb-0 fw-bold">-</p>
                        </div>
                    </div>
                    <hr>
                    <div class="d-grid gap-2">
                         <button class="btn btn-info text-white" onclick="processSkills()">
                            <i class="bi bi-cpu me-1"></i>Extract Skills (Semantic)
                        </button>
                    </div>
                    <small class="text-muted mt-2 d-block">Uses LLM & Embeddings to extract and deduplicate skills.</small>
                </div>
            </div>
        </div>

        <!-- Knowledge Graph -->
        <div class="col-md-6">
            <div class="card mb-3 border-success">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h5 class="card-title"><i class="bi bi-diagram-3 me-2"></i>Knowledge Graph</h5>
                        <!-- Placeholder for graph status if we had a file to check -->
                        <span class="status-dot status-ok"></span> 
                    </div>
                    <p class="text-muted">Rebuilds the Neo4j graph from JSON data.</p>
                    <hr>
                    <div class="d-grid gap-2">
                         <button class="btn btn-success" onclick="processGraph()">
                            <i class="bi bi-share me-1"></i>Rebuild Knowledge Graph
                        </button>
                        <a href="http://localhost:7474" target="_blank" class="btn btn-outline-success">
                            <i class="bi bi-database me-1"></i>Open Neo4j Browser
                        </a>
                    </div>
                    <small class="text-muted mt-2 d-block"><b>Warning:</b> Clears existing database before building.</small>
                </div>
            </div>
        </div>
    </div>

    <!-- Live Job Console -->
    <div class="card">
        <div class="card-header bg-dark text-white d-flex justify-content-between align-items-center">
            <span><i class="bi bi-terminal me-2"></i>Live Job Console</span>
            <span class="badge bg-secondary" id="job-status">IDLE</span>
        </div>
        <div class="card-body bg-black p-0">
            <div class="console-output" id="console-logs">
                Waiting for jobs...
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    const BASE_URL = "/api/admin/data";
    let isJobRunning = false;
    
    // --- Auth Logic ---
    async function checkAuth() {
        try {
            const res = await fetch('/api/auth/check');
            const data = await res.json();
            if (data.is_admin) {
                document.getElementById('auth-overlay').style.display = 'none';
                fetchStatus(); // Start loading data
                setInterval(fetchStatus, 2000); // Start polling
            } else {
                document.getElementById('auth-overlay').style.display = 'flex';
            }
        } catch (e) {
            console.error("Auth check failed", e);
            document.getElementById('auth-overlay').style.display = 'flex';
        }
    }

    async function doLogin() {
        const pass = document.getElementById('auth-pass').value;
        const err = document.getElementById('auth-error');
        
        try {
            const res = await fetch('/api/auth/login', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({password: pass})
            });
            
            const data = await res.json();
            
            if (res.ok) {
                location.reload();
            } else {
                err.textContent = data.error || 'Login failed';
            }
        } catch (e) {
            err.textContent = "Network error";
        }
    }

    async function doLogout() {
        await fetch('/api/auth/logout', {method: 'POST'});
        location.reload();
    }


    // --- Data Logic ---

    async function fetchStatus() {
        try {
            const res = await fetch(`${BASE_URL}/status`);
            if (res.status === 401) return location.reload(); // Re-auth
            
            const data = await res.json();

            // Update Courses
            const c = data.courses;
            document.getElementById('course-count').textContent = c.count || 0;
            document.getElementById('course-updated').textContent = c.last_updated || 'Never';
            document.getElementById('course-status-dot').className = `status-dot ${c.exists ? 'status-ok' : 'status-err'}`;

            // Update Apps
            const a = data.vr_apps;
            document.getElementById('app-count').textContent = a.count || 0;
            document.getElementById('app-updated').textContent = a.last_updated || 'Never';
            document.getElementById('app-status-dot').className = `status-dot ${a.exists ? 'status-ok' : 'status-err'}`;

            // Update Skills
            if (data.skills) {
                const s = data.skills;
                document.getElementById('skill-count').textContent = s.count || 0;
                document.getElementById('skill-updated').textContent = s.last_updated || 'Never';
                document.getElementById('skill-status-dot').className = `status-dot ${s.exists ? 'status-ok' : 'status-err'}`;
            }

            // Update Job Status
            if (data.job) {
                const job = data.job;
                const statusBadge = document.getElementById('job-status');
                statusBadge.textContent = job.status;
                
                // Color code badge
                statusBadge.className = 'badge ' + (
                    job.status === 'RUNNING' ? 'bg-primary' :
                    job.status === 'COMPLETED' ? 'bg-success' :
                    job.status === 'FAILED' ? 'bg-danger' : 'bg-secondary'
                );

                // Update Logs
                if (job.logs && job.logs.length > 0) {
                    const consoleDiv = document.getElementById('console-logs');
                    consoleDiv.innerHTML = job.logs.map(l => `<div>${l}</div>`).join('');
                    consoleDiv.scrollTop = consoleDiv.scrollHeight; // Auto-scroll
                }

                // Check if we should stop fast polling
                if (job.status !== 'RUNNING' && isJobRunning) {
                    isJobRunning = false;
                    toggleInputs(true);
                    alert(`Job ${job.status}: ${job.type}`);
                } else if (job.status === 'RUNNING') {
                    isJobRunning = true;
                    toggleInputs(false);
                }
            }

        } catch (err) {
            console.error("Status fetch error:", err);
        }
    }

    async function updateCourses() {
        if (!confirm("Start course update? This may take time.")) return;
        
        const limit = document.getElementById('course-limit').value;
        const dept = document.getElementById('course-dept').value;
        const semester = document.getElementById('course-semester').value;
        
        const params = { 
            limit: parseInt(limit),
            semester: semester
        };
        
        if (dept) params.department = dept;
        
        triggerJob(`${BASE_URL}/update/courses`, params);
    }

    async function updateApps() {
        if (!confirm("Start VR app update?")) return;
        triggerJob(`${BASE_URL}/update/apps`, { categories: ["education", "training", "productivity"] });
    }

    async function processSkills() {
        if (!confirm("Start Skill Extraction? This uses LLM APIs and may take time.")) return;
        triggerJob(`${BASE_URL}/process/skills`, { top_n: null }); // null = ALL
    }

    async function processGraph() {
        if (!confirm("Rebuild Knowledge Graph? This will CLEAR the database first.")) return;
        triggerJob(`${BASE_URL}/process/graph`, { clear: true });
    }

    async function triggerJob(url, body) {
        try {
            const res = await fetch(url, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(body)
            });
            
            const data = await res.json();
            if (res.status === 409) {
                alert("Error: " + data.error);
            } else {
                // Job started
                isJobRunning = true;
                toggleInputs(false);
                fetchStatus(); // Immediate update
            }
        } catch (err) {
            alert("Network error: " + err.message);
        }
    }

    function toggleInputs(enabled) {
        const btns = document.querySelectorAll('button, select');
        btns.forEach(b => b.disabled = !enabled);
    }

    // Start
    checkAuth();

</script>

</body>
</html>