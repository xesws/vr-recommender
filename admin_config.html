<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VR Recommender - System Configuration</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <style>
        body { background-color: #f4f6f9; }
        .card { border: none; box-shadow: 0 4px 6px rgba(0,0,0,0.1); margin-bottom: 20px; }
        .form-label { font-weight: 600; color: #34495e; }
        /* Overlay styles */
        #auth-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255,255,255,0.95); z-index: 9999;
            display: flex; align-items: center; justify-content: center;
        }
        .sensitive-input { font-family: monospace; }
    </style>
</head>
<body>

<!-- Auth Overlay -->
<div id="auth-overlay">
    <div class="card shadow-lg p-4" style="width: 350px;">
        <h4 class="text-center mb-3"><i class="bi bi-shield-lock-fill text-primary"></i> Admin Login</h4>
        <div class="mb-3">
            <label class="form-label">Password</label>
            <input type="password" id="auth-pass" class="form-control" onkeyup="if(event.key==='Enter') doLogin()">
        </div>
        <button class="btn btn-primary w-100" onclick="doLogin()">Unlock</button>
        <p id="auth-error" class="text-danger mt-2 text-center small"></p>
    </div>
</div>

<nav class="navbar navbar-expand-lg navbar-dark bg-dark">
    <div class="container-fluid">
        <a class="navbar-brand" href="/admin">
            <i class="bi bi-shield-lock me-2"></i>Heinz VR Admin
        </a>
        <div class="collapse navbar-collapse">
            <ul class="navbar-nav me-auto mb-2 mb-lg-0">
                <li class="nav-item">
                    <a class="nav-link" href="/admin">Logs & Stats</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="/admin/data">Data Management</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link active" href="/admin/config">System Config</a>
                </li>
            </ul>
            <button class="btn btn-sm btn-danger" onclick="doLogout()">
                <i class="bi bi-box-arrow-right"></i> Logout
            </button>
        </div>
    </div>
</nav>

<div class="container mt-4">
    <h2 class="mb-4">System Configuration</h2>
    
    <div class="alert alert-info">
        <i class="bi bi-info-circle me-2"></i>
        Changes to LLM settings will trigger a hot-reload of the recommender service.
    </div>

    <form id="config-form" onsubmit="event.preventDefault(); saveConfig();">
        
        <!-- AI Model Settings -->
        <div class="card">
            <div class="card-header bg-white text-primary">
                <h5 class="mb-0"><i class="bi bi-robot me-2"></i>AI Model Settings</h5>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <label class="form-label">OpenRouter API Key</label>
                    <input type="text" class="form-control sensitive-input" name="OPENROUTER_API_KEY" placeholder="sk-or-...">
                    <div class="form-text">Required for LLM ranking and query understanding.</div>
                </div>
                <div class="mb-3">
                    <label class="form-label">Model ID</label>
                    <select class="form-select" name="OPENROUTER_MODEL">
                        <option value="google/gemini-2.0-flash-001">Google Gemini 2.0 Flash (Recommended)</option>
                        <option value="google/gemini-pro-1.5">Google Gemini Pro 1.5</option>
                        <option value="openai/gpt-4o">OpenAI GPT-4o</option>
                        <option value="openai/gpt-3.5-turbo">OpenAI GPT-3.5 Turbo</option>
                        <option value="qwen/qwen-2.5-72b-instruct">Qwen 2.5 72B</option>
                        <option value="meta-llama/llama-3-70b-instruct">Llama 3 70B</option>
                    </select>
                    <div class="form-text">Select the model to use for reasoning.</div>
                </div>
            </div>
        </div>

        <!-- Data Scrapers -->
        <div class="card">
            <div class="card-header bg-white text-success">
                <h5 class="mb-0"><i class="bi bi-bug me-2"></i>Data Scrapers</h5>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <label class="form-label">Firecrawl API Key</label>
                    <input type="text" class="form-control sensitive-input" name="FIRECRAWL_API_KEY" placeholder="fc-...">
                    <div class="form-text">Used for scraping CMU course catalogs.</div>
                </div>
                <div class="mb-3">
                    <label class="form-label">Tavily API Key</label>
                    <input type="text" class="form-control sensitive-input" name="TAVILY_API_KEY" placeholder="tv-...">
                    <div class="form-text">Used for discovering and fetching VR applications.</div>
                </div>
            </div>
        </div>

        <!-- Database Settings -->
        <div class="card">
            <div class="card-header bg-white text-warning">
                <h5 class="mb-0"><i class="bi bi-database me-2"></i>Database Connections</h5>
            </div>
            <div class="card-body">
                <div class="alert alert-warning py-2">
                    <small><i class="bi bi-exclamation-triangle me-1"></i> Changing database settings requires a full application restart to take effect.</small>
                </div>
                <div class="mb-3">
                    <label class="form-label">MongoDB URI</label>
                    <input type="text" class="form-control sensitive-input" name="MONGODB_URI" placeholder="mongodb://...">
                </div>
                <div class="mb-3">
                    <label class="form-label">Neo4j URI</label>
                    <input type="text" class="form-control sensitive-input" name="NEO4J_URI" placeholder="bolt://...">
                </div>
            </div>
        </div>

        <div class="d-grid gap-2 d-md-flex justify-content-md-end mb-5">
            <button type="button" class="btn btn-light me-md-2" onclick="fetchConfig()">Reset</button>
            <button type="submit" class="btn btn-primary px-5">Save Changes</button>
        </div>
    </form>
</div>

<!-- Toast Container -->
<div class="position-fixed bottom-0 end-0 p-3" style="z-index: 11">
    <div id="liveToast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
        <div class="toast-header">
            <strong class="me-auto" id="toast-title">Notification</strong>
            <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
        <div class="toast-body" id="toast-body">
            Action completed.
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    // --- Auth Logic ---
    async function checkAuth() {
        try {
            const res = await fetch('/api/auth/check');
            const data = await res.json();
            if (data.is_admin) {
                document.getElementById('auth-overlay').style.display = 'none';
                fetchConfig(); // Start loading config
            } else {
                document.getElementById('auth-overlay').style.display = 'flex';
            }
        } catch (e) {
            console.error("Auth check failed", e);
            document.getElementById('auth-overlay').style.display = 'flex';
        }
    }

    async function doLogin() {
        const pass = document.getElementById('auth-pass').value;
        const err = document.getElementById('auth-error');
        
        try {
            const res = await fetch('/api/auth/login', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({password: pass})
            });
            
            const data = await res.json();
            
            if (res.ok) {
                location.reload();
            } else {
                err.textContent = data.error || 'Login failed';
            }
        } catch (e) {
            err.textContent = "Network error";
        }
    }

    async function doLogout() {
        await fetch('/api/auth/logout', {method: 'POST'});
        location.reload();
    }

    // --- Config Logic ---

    async function fetchConfig() {
        try {
            const res = await fetch('/api/admin/config');
            if (res.status === 401) return location.reload();

            const config = await res.json();
            populateForm(config);
        } catch (err) {
            console.error("Fetch config error:", err);
            showToast("Error", "Failed to load configuration", "text-danger");
        }
    }

    function populateForm(config) {
        const form = document.getElementById('config-form');
        
        // Iterate over keys in config and match with input names
        for (const [key, value] of Object.entries(config)) {
            const input = form.elements[key];
            if (input) {
                input.value = value;
                
                // Handle select specifically if needed, but .value works for it too
                // If model is custom (not in list), add it temporarily?
                if (input.tagName === 'SELECT' && value) {
                    let found = false;
                    for (let i = 0; i < input.options.length; i++) {
                        if (input.options[i].value === value) {
                            found = true; 
                            break;
                        }
                    }
                    if (!found) {
                        // Add option
                        const opt = document.createElement('option');
                        opt.value = value;
                        opt.text = value + " (Current)";
                        opt.selected = true;
                        input.add(opt);
                    }
                }
            }
        }
    }

    async function saveConfig() {
        const form = document.getElementById('config-form');
        const formData = new FormData(form);
        const data = Object.fromEntries(formData.entries());
        
        // Button loading state
        const btn = form.querySelector('button[type="submit"]');
        const originalText = btn.innerText;
        btn.innerText = "Saving...";
        btn.disabled = true;

        try {
            const res = await fetch('/api/admin/config', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(data)
            });
            
            const result = await res.json();
            
            if (res.ok) {
                showToast("Success", result.message || "Configuration saved.");
                if (result.warning) {
                    showToast("Warning", result.warning, "text-warning");
                }
                // Reload config to show masked values again (optional)
                // fetchConfig(); 
            } else {
                showToast("Error", result.error || "Failed to save", "text-danger");
            }
        } catch (err) {
            console.error("Save error:", err);
            showToast("Error", "Network error", "text-danger");
        } finally {
            btn.innerText = originalText;
            btn.disabled = false;
        }
    }

    function showToast(title, message, textClass="text-dark") {
        const toastEl = document.getElementById('liveToast');
        document.getElementById('toast-title').innerText = title;
        const body = document.getElementById('toast-body');
        body.innerText = message;
        body.className = "toast-body " + textClass;
        
        const toast = new bootstrap.Toast(toastEl);
        toast.show();
    }

    // Start
    checkAuth();
</script>

</body>
</html>
